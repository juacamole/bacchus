#!/bin/bash

# Script to deploy Ionic app to Android emulator
# Usage: ./deploy [emulator-id]

# Set Android SDK environment variables
export ANDROID_SDK_ROOT=/opt/android-sdk
export ANDROID_HOME=/opt/android-sdk
export PATH=$PATH:$ANDROID_SDK_ROOT/platform-tools:$ANDROID_SDK_ROOT/emulator

# Check if emulator ID was provided
if [ -z "$1" ]; then
    echo "üîç Checking for running emulators..."
    DEVICES=$(adb devices | grep -v "List of devices" | grep "device$")
    
    if [ -z "$DEVICES" ]; then
        echo "‚ùå No emulator found!"
        echo "   Please start the emulator first: ./start-emulator.sh"
        echo "   Or specify emulator ID: ./deploy emulator-5554"
        exit 1
    fi
    
    # Get first device
    TARGET=$(echo "$DEVICES" | head -1 | awk '{print $1}')
    echo "‚úÖ Found emulator: $TARGET"
else
    TARGET=$1
    echo "üì± Using emulator: $TARGET"
fi

# Build the web app first
echo "üì¶ Building web app..."
npm run build

if [ $? -ne 0 ]; then
    echo "‚ùå Build failed!"
    exit 1
fi

# Sync Capacitor
echo "üîÑ Syncing Capacitor..."
npx cap sync android

if [ $? -ne 0 ]; then
    echo "‚ùå Capacitor sync failed!"
    exit 1
fi

# Deploy to emulator
echo "üöÄ Deploying app to $TARGET..."
ionic capacitor run android --target=$TARGET

if [ $? -eq 0 ]; then
    echo "‚úÖ Deployment successful!"
else
    echo "‚ùå Deployment failed!"
    exit 1
fi

